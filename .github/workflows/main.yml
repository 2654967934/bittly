name: Build App

on: push

jobs:
  build-window-package:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v3
        with:
          node-version: 16.14.2
      - uses: actions/setup-python@v4
        with:
          python-version: 2.7 
      - uses: actions/setup-python@v4
        with:
          python-version: 3.11
      - uses: microsoft/setup-msbuild@v1.1
        with:
          vs-version: 15.9

      # get package.json version
      - name: get-version-from-package-json
        uses: polyseam/get-version-from-package-json@v.1.0.0
        id: package-version
        with:
          path-to-file: './package.json'
      - name: print-version
        run: echo "The version key in your json is ${{steps.package-version.outputs.version}}"

      # # setup qshell
      # - run: Invoke-RestMethod -Uri 'https://devtools.qiniu.com/qshell-v2.9.2-windows-386.zip' -OutFile 'qshell.zip'
      # - run: Expand-Archive -LiteralPath qshell.zip -DestinationPath ./
      # - run: ./qshell --version
      # - run: ./qshell account ${{secrets.QINIU_AK}} ${{secrets.QINIU_SK}} ${{secrets.QINIU_ACCOUNT_NAME}}

      # # install deps
      # - run: npm install --python=python2.7

      # # build 32bit package and upload
      # - run: npm run electron:build -- --ia32
      # - run: >
      #     ./qshell fput ${{secrets.QINIU_BUCKET}} 
      #     download/${{steps.package-version.outputs.current-version}}/bittly-${{steps.package-version.outputs.current-version}}-win-ia32.exe 
      #     ./dist_electron/bittly-${{steps.package-version.outputs.current-version}}.exe

  # build-linux-package:
  #   runs-on: ubuntu-22.04
  #   steps:
  #   - run: sudo apt install python2
  #   - run: sudo apt-get install libbluetooth-dev
  #   - uses: actions/checkout@v1
  #   - name: Setup node.js
  #     uses: actions/setup-node@v1
  #     with:
  #       node-version: 16.14.2

  #   # install qshell to upload packages to qiniu
  #   - run: wget https://devtools.qiniu.com/qshell-v2.9.2-linux-386.tar.gz
  #   - run: tar -zxvf qshell-v2.9.2-linux-386.tar.gz
  #   - run: chmod u+x qshell
  #   - run: ./qshell --version
  #   - run: ./qshell account ${{secrets.QINIU_AK}} ${{secrets.QINIU_SK}} ${{secrets.QINIU_ACCOUNT_NAME}}
    
  #   # get package.json version
  #   - name: get-npm-version
  #     id: package-version
  #     uses: martinbeentjes/npm-get-version-action@main

  #   # install deps
  #   - run: npm install --python=python2.7

  #   # build 32bit package and upload
  #   - run: npm run electron:build -- --ia32
  #   - run: >
  #       ./qshell fput ${{secrets.QINIU_BUCKET}} 
  #       download/${{steps.package-version.outputs.current-version}}/bittly-${{steps.package-version.outputs.current-version}}-i386.AppImage 
  #       ./dist_electron/bittly-${{steps.package-version.outputs.current-version}}-i386.AppImage

  #   # build 64bit package and upload
  #   - run: npm run electron:build -- --x64
  #   - run: >
  #       ./qshell fput ${{secrets.QINIU_BUCKET}} 
  #       download/${{steps.package-version.outputs.current-version}}/bittly-${{steps.package-version.outputs.current-version}}-x86_64.AppImage 
  #       ./dist_electron/bittly-${{steps.package-version.outputs.current-version}}-x86_64.AppImage
    
  #   # update server variables
  #   - run: >
  #       curl --location --request POST 'https://bittly.sigechen.com/deploy/set-variable' 
  #       --form 'key="linux_released_at"' 
  #       --form "value=$(date '+%Y-%m-%d')" 
  #       --form 'secret="${{secrets.SERVER_DEPLOY_SECRET}}"' -s
